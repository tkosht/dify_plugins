name: Test All Subsystems

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'app/**'
      - 'tests/**'
      - '**/pyproject.toml'
      - '**/uv.lock'
      - '.github/workflows/test-all-subsystems.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'tests/**'
      - '**/pyproject.toml'
      - '**/uv.lock'
      - '.github/workflows/test-all-subsystems.yml'

jobs:
  discover-subsystems:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Discover subsystems
        id: set-matrix
        run: |
          # Find all directories under app/ that contain pyproject.toml
          SUBSYSTEMS=$(find app -name "pyproject.toml" -type f | xargs dirname | jq -R -s -c 'split("\n")[:-1]')
          echo "Found subsystems: $SUBSYSTEMS"
          echo "matrix={\"subsystem\":$SUBSYSTEMS}" >> $GITHUB_OUTPUT

  test-subsystem:
    needs: discover-subsystems
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        subsystem: ${{ fromJson(needs.discover-subsystems.outputs.matrix).subsystem }}
    defaults:
      run:
        working-directory: ${{ matrix.subsystem }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --all-groups --all-extras
      
      - name: Run linters
        run: |
          if [ -d "src" ]; then
            uv run ruff check src/ tests/ || echo "Ruff not available, skipping"
            uv run black --check src/ tests/ || echo "Black not available, skipping"
          elif [ -d "app" ]; then
            uv run ruff check app/ tests/ || echo "Ruff not available, skipping"
            uv run black --check app/ tests/ || echo "Black not available, skipping"
          else
            echo "No src directory found, skipping linters"
          fi

      - name: Type checking
        run: |
          if [ -d "src" ]; then
            uv run mypy src/ --ignore-missing-imports --explicit-package-bases || echo "Mypy not available, skipping"
          elif [ -d "app" ]; then
            uv run mypy app/ --ignore-missing-imports --explicit-package-bases || echo "Mypy not available, skipping"
          else
            echo "No src directory found, skipping type checking"
          fi

      - name: Run unit tests with coverage
        run: |
          if [ -d "tests" ]; then
            # Run only unit tests in CI to avoid timeout issues with integration tests
            if [ -d "src" ]; then
              uv run pytest tests/unit/ \
                --cov=src \
                --cov-report=xml \
                --cov-report=term-missing \
                --cov-fail-under=85 \
                -v || echo "No unit tests found"
            else
              uv run pytest -v || echo "No unit tests found"
            fi
          else
            echo "No tests directory found"
          fi
      
      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./${{ matrix.subsystem }}/coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: ${{ matrix.subsystem }}-py${{ matrix.python-version }}
        continue-on-error: true

  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']  # Run integration tests only on one Python version
        subsystem: ['.']  # Single root subsystem in this repo
    defaults:
      run:
        working-directory: ${{ matrix.subsystem }}
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --all-groups --all-extras
      
      - name: Run integration tests
        if: env.OPENAI_API_KEY != '' || env.ANTHROPIC_API_KEY != '' || env.GOOGLE_API_KEY != ''
        run: |
          if [ -d "tests/integration" ]; then
            uv run pytest tests/integration/ \
              -v \
              --tb=short \
              --timeout=300 \
              -k "not test_performance_baseline" || true
          else
            echo "No integration tests directory, skipping"
          fi
        continue-on-error: true

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          uv sync --all-groups --all-extras

      - name: Enforce schemaless override policy
        run: |
          if rg -n "allow_schemaless_tool_args:\\s*true" app/gpt5_agent_strategies; then
            echo "allow_schemaless_tool_args:true is forbidden in app defaults"
            exit 1
          fi

      - name: Run security audits
        run: |
          uvx --with pip-audit pip-audit -r app/openai_gpt5_responses/requirements.txt
          uvx --with pip-audit pip-audit -r app/gpt5_agent_strategies/requirements.txt
          uvx --with bandit bandit -q -r app/openai_gpt5_responses app/gpt5_agent_strategies -x tests

  summary:
    needs: [test-subsystem, integration-tests, security-audit]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Test Summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All subsystem tests have been executed." >> $GITHUB_STEP_SUMMARY
          echo "Security audit gate (pip-audit/bandit) has been executed." >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results for details." >> $GITHUB_STEP_SUMMARY
